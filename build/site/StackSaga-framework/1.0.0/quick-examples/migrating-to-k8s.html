<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
<!--    <meta name="description" content="stack saga is a ecosystem as well as a framework to implement saga orchestration pattern with for spring boot. The framework provides a spring boot starter library to implement and a dashboard to manipulate all the transactions.">-->
    <meta name="author" content="Mafei (Tharindu Kalhara)">
    <title>StackSaga Demo (Core concept practice) :: StackSAGA Docs</title>
    <meta name="page-spec" content="StackSaga-framework:quick-examples:migrating-to-k8s.adoc">
    <meta name="description" content="StackSaga Quick Start With Kubernetes">
    <meta name="keywords" content="SatckSaga Spring microservice,spring boot saga,spring cloud microservice saga, saga design pattern,saga orchestration spring boot">
    <meta name="generator" content="Antora 3.1.7">
<link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/icon.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><script async src="https://www.googletagmanager.com/gtag/js?id=[object Object]"></script>
<script>function gtag() {
    dataLayer.push(arguments)
};window.dataLayer = window.dataLayer || [];
gtag('js', new Date());
gtag('config', '[object Object]')</script>
<script src="https://kit.fontawesome.com/0cc2c17262.js" crossorigin="anonymous"></script>
<link rel="icon" href="../../../_/img/fev/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" sizes="180x180" href="../../../_/img/fev/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../../_/img/fev/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../_/img/fev/favicon-16x16.png">  </head>
  <body class="article">
<header class="header">
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item logo" title="Asciidoctor" href="https://www.stacksaga.org"><img
                    src="../../../_/img/stack-saga-icon.svg" alt="Asciidoctor" width="48"></a>
            <a class="navbar-item title" href="../../..">StackSAGA Docs</a>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">

                <a class="navbar-item" href="https://github.com/asciidoctor" target="_blank" rel="noopener">
                    <span class="icon"><img src="../../../_/img/octicons-16.svg#view-mark-github"></span>
                </a>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<div class="nav-container">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active is-loading" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" title="Toggle expand/collapse all"></button>
    <h3 class="title"><a href="../index.html">StackSaga Framework</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction To Microservice</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><strong class="green">StackSaga Architecture</strong></span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/saga-architecture.html">Introduction to the Saga Design Pattern</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/introduction-to-stacksaga.html">Introduction to StackSaga</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/key_steps_of_ecosystem.html">Key Steps of ecosystem in High-Level</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/SEC.html">Saga execution coordinator. (SEC)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/event_store.html">Event Store</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/aggregator.html">Saga Aggregator.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/executor_architecture.html">Saga Executors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/how_executors_behave_in_the_application.html">Aggregator Vs Executors.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/aggregator_versioning.html">Aggregator Versioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/version_casting_architecture.html">Aggregator Version Casting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/dual_consistency_problem_of_sec_in_microservice.html">Dual-Consistency problem of SEC in microservice.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/replay-transaction.html">Transaction Replay.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture/stack_saga_transaction_type.html">StackSaga Transaction Types</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><strong class="green">StackSaga Core</strong></span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/create-aggregator.html">Creating Aggregator Class</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/saga_serializable.html">Creating SagaSerializable Class for Aggregator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/aggregator_key_gen_custom_implementation.html">Aggregator KeyGen</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/aggregator_mapper_implementation.html">Custom Aggregator Mapper</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/complex_aggrgator.html">Full Aggregator implementation.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/aggregator_serialization.html">Aggregator Serialization And Deserialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/aggregator_casting.html">Aggregator&#8217;s Event Casting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/saga_executors.html">Saga Executors.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/retryable_executor_exception.html">RetryableExecutorException</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/non_retryable_executor_exception.html">NonRetryableExecutorException</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/usage_of_exceptions.html">Usage of Executors[Q&amp;C] With Exceptions </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/saga_exception_annotation.html">@SagaException Annotation </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/saga_revert_hint_store.html">RevertHintStore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/saga_event_handler.html">Saga Execution Event Listener </a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/uncommitted_data_listener.html">UncommittedDataListener</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/saga_template.html">SagaTemplate&lt;A&gt;</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/custom_thread_pool_configuration.html">Custom Thread-pool configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/stacksaga_in_kubernetes.html">Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><strong class="green">Configuration Properties</strong></span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/core-configuration-properties.html">Core Configuration Properties</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/sql-datasource-configuration-properties.html">JDBC Datasource Configuration Properties</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/kubernetes-support-configuration-properties.html">Kubernetes Support Configuration Properties</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/eureka-support-configuration-properties.html">Eureka Support Configuration Properties</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../framework/admin-configuration-properties.html">Admin Configuration Properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><strong class="green">Admin Dashboard</strong></span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../admin/stacksaga_admin.html">StackSaga Admin Dashboard</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><strong class="green">Demo Implementations</strong></span>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quick-start.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stacksaga-demo.html">StackSaga Demo (Core concept practice)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="stackSaga-demo-with-docker-and-docker-compose.html">Migrate To Docker Environment.</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="k8s_with_k8s/migration-to-kubernetes.html">Migrate To Kubernetes Environment</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
  <script>
;(function () {
  var panel = document.querySelector('.nav-panel-menu')
  var page
  var hash = window.location.hash
  if (hash) {
    if (~hash.indexOf('%')) hash = decodeURIComponent(hash)
    if (~hash.indexOf('"')) hash = hash.replace(/(?=")/g, '\\')
    var link = panel.querySelector('.nav-link[href="' + hash + '"]')
    if (link) page = link.parentNode
    else if ((page = panel.querySelector('.is-current-url'))) page.classList.add('is-provisional')
  } else {
    page = panel.querySelector('.is-current-url')
  }
  if (page) {
    var ancestor = page
    while ((ancestor = ancestor.parentNode) && ancestor !== panel) {
      if (ancestor.className === 'nav-item') ancestor.classList.add('is-current-path', 'is-active')
    }
    page.classList.add('is-current-page', 'is-active')
    if (panel.scrollHeight > panel.clientHeight) {
      var panelRect = panel.getBoundingClientRect()
      var linkRect = page.querySelector('.nav-link').getBoundingClientRect()
      panel.scrollTop += Math.round(linkRect.top - panelRect.top - (panelRect.height - linkRect.height) * 0.5)
    }
  } else {
    panel.scrollTop = 0
  }
  panel.classList.remove('is-loading')
})()
  </script>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">StackSaga Framework</span>
    <span class="version">1.0.0 SNAPSHOT</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../StackSaga-admin/2.5/index.html">StackSaga Admin</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../StackSaga-admin/2.5/index.html">2.5-beta.1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">StackSaga Framework</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1.0.0 SNAPSHOT</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">StackSaga Framework</a></li>
    <li><a href="migrating-to-k8s.html" class="discrete">StackSaga Demo (Core concept practice)</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">StackSaga Demo (Core concept practice)</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this demo, we are focusing on how to implement the StackSaga things in the spring boot in microservice architecture.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>IF you are new to StackSaga, it is recommended to read the <a href="../architecture/aggregator.html" class="xref page">architecture</a> and <a href="../framework/create-aggregator.html" class="xref page">reference documentation</a>
for reading individual components.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In this example, we have 4 utility microservices.
,<code>payment-service</code> and <code>stock-service.</code> and as the proxy server we use <a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Api Gateway</a>.
The requirement is the clients can place an order and then the order request should be completed go through these 4 services.</p>
</div>
<div class="paragraph">
<p>Each services' responsibilities as follows.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code><strong>order-service</strong></code>
</td>
<td class="hdlist2">
<p>Order service is responsible for accepting the place order request and managing the entire transaction as the orchestrator. and also as a utility service, the service is responsible for storing the order related specific data in the order-service database.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code><strong>user-service</strong></code>
</td>
<td class="hdlist2">
<p>To make the process we want to have the user details like delivery address.
User-service provides the endpoints to fetch the user&#8217;s data.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code><strong>payment-service</strong></code>
</td>
<td class="hdlist2">
<p>In the placing order process, the user service involves to execute to main steps.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To make the Pre-Auth before doing the real transaction and to check that the payment can be done or not.</p>
</li>
<li>
<p>To make the payment (Real transaction).
All the steps are done smoothly, finally the reserved transaction should be made.
These endpoints are provided by the <code>payment-service</code>.</p>
</li>
</ol>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<code><strong>stock-service</strong></code>
</td>
<td class="hdlist2">
<p>After making the pre-auth process, we should update the real stock.
<code>stock-service</code> is responsible to update the real stock.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are 3 utility services in the cluster called <code>order-service,</code> <code>user-service</code> and <code>stock-service.</code> as well as <a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Api Gateway</a> is used as the (In K8s it is can be called ingress service) Application Load Balancer (ALB) and as well as the Reverse proxy server.
The <code>order-service</code> act as the StackSaga <a href="#//">orchestrator service here</a>.
As mentioned above, Eureka or any of Discovery clients are not used for Service-Discovery and Service-Registry.
To overcome the capability of Service-Discovery, it is used inbuilt <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes Service</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_high_level_implementation_diagram"><a class="anchor" href="#_high_level_implementation_diagram"></a>High-level Implementation Diagram.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>stack-saga-icon.svg[width=20]
You can see below what we are going to implement from the general perspective.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/stacksaga-example-drawing-stacksaga-kubernetes-spring-cloud-api-gateway-demo-hight-level.drawio.svg" alt="stacksaga example drawing stacksaga kubernetes spring cloud api gateway demo high-level architecture diagram">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In the diagram, StackSaga icons <span class="image"><img src="_images/stack-saga-icon.svg" alt="stack saga icon" width="20"></span> are shown which parts StackSaga interact.</p>
</li>
<li>
<p>Red lines are shown how the StackSaga Admin interacts with the process and the request-flow.</p>
</li>
<li>
<p>Black lines are shown how the regular requests are done.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_high_level_implementation_diagram_with_kubernetes_flags"><a class="anchor" href="#_high_level_implementation_diagram_with_kubernetes_flags"></a>High-level implementation diagram with Kubernetes Flags.</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="_images/stacksaga-example-drawing-stacksaga-kubernetes-spring-cloud-api-gateway-demo-hight-level-with-k8s-flags.drawio.svg" alt="stacksaga example drawing stacksaga kubernetes spring cloud api gateway demo high-level architecture diagram">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The Kubernetes related blue icons indicate how Kubernetes interacts with the deployment.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation"><a class="anchor" href="#_implementation"></a>Implementation</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In this demo we are not going to implement all the functionalities that StackSaga provides in-detail.
Here we focus how a StackSaga application set is deployd in the Kubernetes cluster and how the communication part is done.
If you want to practice all the features in detail, you can refer this <a href="#//">comprehensive demo</a> and it will describe all the topics step by step.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As the first step, let&#8217;s create our services one by one.</p>
</div>
<div class="sect2">
<h3 id="_create_order_service_orchestrator_service"><a class="anchor" href="#_create_order_service_orchestrator_service"></a>Create Order-Service (Orchestrator Service)</h3>
<div class="paragraph">
<p>The <code>order-service</code> is little bit special than the other utility services, because the <code>order-service</code> is the responsible for managing the entire transaction here.
That&#8217;s why it called as <a href="#//">Orchestrator Service</a>.
And the next reason is that StackSaga involves that kind of service in your entire system.
Selecting a service as an Orchestrator service or not depends on your requirement.</p>
</div>
<div class="sect3">
<h4 id="_create_order_the_project_with_spring_initializer"><a class="anchor" href="#_create_order_the_project_with_spring_initializer"></a>Create order the project with spring initializer</h4>
<div class="paragraph">
<p>Go to the <a href="https://start.spring.io/">spring initializer</a> and create your project with the following Dependencies.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spring-boot-starter-web</code></p>
</li>
<li>
<p><code>spring-boot-starter-data-jpa</code></p>
</li>
<li>
<p><code>mysql-connector-java</code></p>
</li>
<li>
<p><code>lombok</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In general, you would add <code>spring-eureka-client</code> but in this example eureka is not used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After creating your project, add the StackSaga dependencies in the dependencies section.
There are 3 dependencies to be added based on your implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can add the <code>stacksaga-spring-boot-starter</code> dependency based on the spring version that you wish to use.
<mark>In this example, we will be using spring2.X.</mark></p>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring 2.X</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
  &lt;artifactId&gt;stacksaga-spring-boot-2-starter&lt;/artifactId&gt;
  &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Spring 3.X</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
  &lt;artifactId&gt;stacksaga-spring-boot-2-starter&lt;/artifactId&gt;
  &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Due to the database has been selected as Mysql, you have to add <code>stacksaga-mysql-support</code> dependency.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">:</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
    &lt;artifactId&gt;stacksaga-mysql-support&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Due to we are going to deploy the application in the Kubernetes cluster environment, <code>stacksaga-connect-k8s-support</code> dependency should be added.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">:</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
    &lt;artifactId&gt;stacksaga-connect-k8s-support&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the <code>pom.xml</code> file will be like below.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/pom.xml"><span class="icon black"><i class="fa fa-github fa-2x"></i></span></a> pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.0&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;

    &lt;groupId&gt;org.example&lt;/groupId&gt;
    &lt;artifactId&gt;order-service&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;8&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;8&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;spring-cloud.version&gt;2021.0.3&lt;/spring-cloud.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;

        ...
        ...
        &lt;!--othe dependencies--&gt;

        &lt;!--StackSaga related dependacies --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
            &lt;artifactId&gt;stacksaga-spring-boot-2-starter&lt;/artifactId&gt;
            &lt;version&gt;1.0.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
            &lt;artifactId&gt;stacksaga-mysql-support&lt;/artifactId&gt;
            &lt;version&gt;1.0.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.stacksaga&lt;/groupId&gt;
            &lt;artifactId&gt;stacksaga-connect-k8s-support&lt;/artifactId&gt;
            &lt;version&gt;1.0.0&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_order_service_overview"><a class="anchor" href="#_order_service_overview"></a>Order-Service Overview.</h4>
<div class="paragraph">
<p>You know that we have to access more services besides this <code>order-service</code> to fully complete the entire place-order request.
To access those services in general, you would use <strong>service-layer</strong> and call those services manually by using any httpclient like RestTemplate, Feign client, Okhttp, and so on.
Instead of that manual unorganized way, StackSaga offers better wrapper blocks for each execution.
It is called as <code>executors</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read the <a href="#//">reference documentation</a>
to have a better understanding and best practices regarding the <code>SagaExecutors</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>According to the <a href="#//">Saga design pattern</a>, you know that we should have a Compensating process for all the execution (All the executions that make some changes in a database).
Due to the fact that the StackSaga framework is one of Saga implementations, it should be provided the primary execution and also a Compensating execution to make a Compensating when the entire process is failed at any point.</p>
</div>
<div class="paragraph">
<p>Based on having a Compensating or not, the executors are two types called <code>command-executor</code> and <code>query-executor</code>.
<code>command-executor</code> have both primary execution and the Compensating execution.
If it is <code>query-executor</code>, it has only primary execution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_stacksaga_combines_with_controller_service_and_repository_architecture"><a class="anchor" href="#_how_stacksaga_combines_with_controller_service_and_repository_architecture"></a>How StackSaga combines with Controller Service and Repository architecture?</h4>
<div class="paragraph">
<p>In spring applications we follow <code>controller</code>, <code>service</code> and <code>repository</code> layered architecture.
StackSaga suggest another middle layer between the <code>controller</code> layer and the <code>service</code> layer called <mark><code>executor-layer</code></mark>.
The <code>executor-layer</code> is the place the executors are created.
Let&#8217;s see step by step how StackSaga involves the process.</p>
</div>
<div class="paragraph">
<p>Here you can see the entire process in a diagram from based on the order-service (orchestrator-service).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/stacksaga-example-executors-architecture-in-order-service.drawio.svg" alt="stacksaga microservice example executors architecture in order service"></span></p>
</div>
<div class="paragraph">
<p>In brief, The client makes an order place request and the request comes to the order-service via the api-cloud-gateway.
And then we initialize a special object called <code>Aggregator</code>
and it is handed over to the SEC (Saga Execution coordinator), and the SEC will handle the entire execution by executing each every atomic execution.
The atomic executions have been provided inside the executors.</p>
</div>
<div class="paragraph">
<p>Here you can see the summarized table for your convenience.</p>
</div>
<div class="openblock scrollable">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Executor Class Name</th>
<th class="tableblock halign-left valign-top">Execution_Requirement</th>
<th class="tableblock halign-left valign-top">Target_Service</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Process-Execution</th>
<th class="tableblock halign-left valign-top">Revert-Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>UserDetailExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch the user&#8217;s details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-green">QUERY_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getUserDetails</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>OrderInitializeExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initialize the order at the first.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initializeOrder()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cancelOrder()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>PreAuthExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Make the Pre-Auth process.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payment-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>makePreAuth()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>releasePreAuth()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>StockUpdateExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update the stock from the store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stock-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updateStock()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restoreStock()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>MakePaymentExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finalize the order by making the real payment.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payment-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>makePayment()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">?</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_aggregator"><a class="anchor" href="#_creating_the_aggregator"></a>Creating the aggregator</h4>
<div class="paragraph">
<p>You know that the request comes to the order-service at the first (for downstream services), and it tries to handle the entire request by calling to other utility services.
To start the execute the request, the <code>order-service</code> should have an Aggregator class that extend from the <code>SagaAggregator</code> class.
And as well as to verify the aggregator object is serializable well or not, we should provide a <a href="../framework/aggregator_serialization.html" class="xref page">sagaSerializable</a>'s implementation.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read the <a href="#//">reference documentation</a>
to have a better understanding and best practices regarding the <code>SagaAggregator</code>.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.example.aggregator;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Getter;
import lombok.Setter;
import org.example.aggregator.dto.OrderItem;
import org.stacksaga.Aggregator;
import org.stacksaga.SagaSerializable;
import org.stacksaga.core.annotation.SagaAggregator;
import org.stacksaga.core.annotation.SagaAggregatorVersion;

import java.util.List;

@SagaAggregator(
        version = @SagaAggregatorVersion(major = 1, minor = 0, patch = 0),
        name = "PlaceOrderAggregator",
        sagaSerializable = PlaceOrderAggregatorSerializer.class
)
@Getter
@Setter
@ToString
public class PlaceOrderAggregator extends Aggregator {


    /**
     * The relevant user to the order.
     */
    @JsonProperty("user_id")
    private String userId;
    /**
     * The item list that user order.
     */
    @JsonProperty("items")
    private List&lt;OrderItem&gt; items;

    /**
     * The amount to be paid.
     */
    @JsonProperty("amount")
    private Double amount;

    /**
     * Pre-Auth Reference for release or make the payment.
     */
    @JsonProperty("pre_auth_ref")
    private String preAuthRef;

    /**
     * Payment ID after the payment.
     */
    @JsonProperty("payment_id")
    private String paymentId;

    @JsonProperty("executions")
    private List&lt;String&gt; executions = new ArrayList&lt;&gt;();

    @JsonIgnore
    private Boolean hasRevertError = false;

    public PlaceOrderAggregator() {
        super(PlaceOrderAggregator.class);
    }
}


class PlaceOrderAggregatorSerializer extends SagaSerializable&lt;PlaceOrderAggregator&gt; {

    public PlaceOrderAggregatorSerializer() {
        PlaceOrderAggregator placeOrderAggregator = new PlaceOrderAggregator();
        placeOrderAggregator.setUserId("user-1");
        placeOrderAggregator.setAmount(100.00);
        placeOrderAggregator.setItems(new ArrayList&lt;&gt;());
        placeOrderAggregator.getItems()
                .add(OrderItem.builder()
                        .itemId("item-1")
                        .itemPrice(100.00)
                        .build()
                );
        this.put("sample-1", placeOrderAggregator);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To make the code more readable and clear, I have used <a href="https://projectlombok.org/:"><code>lombok</code></a>
and builder pattern for creating the objects through the demo.
It is not required, and you are free to use the traditional way by creating getters and setters manual.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the <code>PlaceOrderAggregator</code> has the data that we want to access while the entire transaction process.
Those data will be updated time to time from each execution.</p>
</div>
<div class="paragraph">
<p>Now the aggregator is ready to store and carry out the data throughout the entire process.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_ordercontroller_api_endpoint"><a class="anchor" href="#_creating_ordercontroller_api_endpoint"></a>Creating OrderController (API Endpoint).</h3>
<div class="paragraph">
<p>As per the diagram, you know that the request comes to the <code>/order/place</code> endpoint and also the handing over the execution to the stacksaga is happened in this controller class.</p>
</div>
<div id="orderController_source" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestController
@RequestMapping("/order")
@RequiredArgsConstructor
public class OrderController {

    <i class="conum" data-value="1"></i><b>(1)</b>
    private final SagaTemplate&lt;PlaceOrderAggregator&gt; placeOrderAggregatorSagaTemplate;

    @PostMapping("/place")
    @ResponseStatus(HttpStatus.ACCEPTED)
    public PlaceOrderDto.ResponseBody createOrder(@RequestBody PlaceOrderDto.RequestBody requestBody) {
        <i class="conum" data-value="2"></i><b>(2)</b>
        final PlaceOrderAggregator placeOrderAggregator = new PlaceOrderAggregator();
        placeOrderAggregator.setUserId(requestBody.getUserId());
        placeOrderAggregator.setItems(requestBody.getItems());
        placeOrderAggregator.setAmount(
                requestBody.getItems()
                        .stream()
                        .map(orderItem -&gt; orderItem.getItemPrice() * orderItem.getQty())
                        .mapToDouble(Double::doubleValue)
                        .sum()
        );

        placeOrderAggregator.setHasRevertError(requestBody.getHasRevertError());
        placeOrderAggregator.getExecutions().add("INIT:" + LocalDateTime.now());
        log.debug("placeOrderAggregator:{}", placeOrderAggregator);

        <i class="conum" data-value="3"></i><b>(3)</b>
        placeOrderAggregatorSagaTemplate.process(
                placeOrderAggregator,
                UserDetailExecutor.class
        );
        <i class="conum" data-value="4"></i><b>(4)</b>
        return PlaceOrderDto.ResponseBody.builder()
                .orderId(placeOrderAggregator.getAggregatorTransactionId())
                .message("order has been submitted successfully")
                .build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Autowire the <a href="../framework/saga_template.html" class="xref page">SagaTemplate</a> for handing over the execution to the framework.
Your target aggregator class should be provided to the <code>SagaTemplate</code> as a type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize the <a href="creating-aggregator.html" class="xref page">PlaceOrderAggregator</a>  [<a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/aggregator/PlaceOrderAggregator.java"><span class="icon black"><i class="fa fa-github"></i></span></a>] and set the data that should be added initially.
In our case, the necessary data that are given from the endpoint are added to the aggregator object.
You can see the initialized data at the dashboard <a href="#//">like this</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Handing over the execution to the framework by passing the initialized aggregator object, and the executor class that the execution should be started.
From here the execution will be handled by the StackSaga execution coordinator <a href="#//">(SEC)</a> asynchronously.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the response object to the client by using the <code>aggregatorTransactionId</code>.
<code>aggregatorTransactionId</code> can access through your aggregator object due to that id comes from the <code>Aggregator</code> super.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Related Classes' links</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/aggregator/PlaceOrderAggregator.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <a href="creating-aggregator.html" class="xref page">PlaceOrderAggregator</a></p>
</li>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/executor/UserDetailExecutor.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <a href="creating-UserDetailExecutor.html#creating_user_detail_executor " class="xref page">UserDetailExecutor</a></p>
</li>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/dto/PlaceOrderDto.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <code>PlaceOrderDto.RequestBody</code></p>
</li>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/dto/PlaceOrderDto.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <code>PlaceOrderDto.ResponseBody</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating_order_initialize_executor"><a class="anchor" href="#creating_order_initialize_executor"></a>Creating OrderInitializeExecutor</h3>
<div class="paragraph">
<p>You know that the request comes to the <code>OrderController</code>
and the request is transferred to the <code>UserDetailExecutor</code> as the first step to collect the user details.
And next, we are going to initiate the order in the own service (order-service).
To initiate the order will be creating an executor called <code>OrderInitializeExecutor</code>.</p>
</div>
<div class="paragraph">
<p>The OrderInitializeExecutor should be a command-executor because the primary execution (updating order database) makes some changes in the database, and then if a failure occurred at some point after executing the order initialization process, it should be recovered again.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/executor/OrderInitializeExecutor.java"><span class="icon black"><i class="fa fa-github fa-2x"></i></span> OrderInitializeExecutor.class</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
@SagaExecutor(executeFor = "order-service", liveCheck = false, value = "OrderInitializeExecutor")
@RequiredArgsConstructor
public class OrderInitializeExecutor implements CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    <i class="conum" data-value="3"></i><b>(3)</b>
    private final OrderService orderService;
    private final ObjectMapper objectMapper;

    @Override <i class="conum" data-value="4"></i><b>(4)</b>
    public ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(PlaceOrderAggregator currentAggregator, ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager) throws RetryableExecutorException, NonRetryableExecutorException {
        try {
            currentAggregator.getExecutions().add(this.getClass().getSimpleName() + ":" + LocalDateTime.now());
            <i class="conum" data-value="5"></i><b>(5)</b>
            this.orderService.initialize(
                    OrderEntity
                            .builder()
                            .orderId(currentAggregator.getAggregatorTransactionId())
                            .userId(currentAggregator.getUserId())
                            .createAt(LocalDateTime.now())
                            .isCancelled(false)
                            .items(objectMapper.writeValueAsString(currentAggregator.getItems()))
                            .build()
            );
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
        <i class="conum" data-value="6"></i><b>(6)</b>
        return stepManager.next(PreAuthExecutor.class, OrderStatus.INITIALIZED_ORDER);
    }

    @Override
    public SagaExecutionEventName doRevert(NonRetryableExecutorException processException, PlaceOrderAggregator finalAggregatorState, RevertHintStore revertHintStore) throws RetryableExecutorException {
        <i class="conum" data-value="7"></i><b>(7)</b>
        this.orderService.cancelOrder(finalAggregatorState.getAggregatorTransactionId());
        <i class="conum" data-value="8"></i><b>(8)</b>
        revertHintStore.put(
                String.valueOf(System.currentTimeMillis()),
                this.getClass().getSimpleName() + ":doRevert"
        );
        <i class="conum" data-value="9"></i><b>(9)</b>
        if (finalAggregatorState.getHasRevertError()) {
            throw new RuntimeException("dummy error for revert-failed.");
        }
        <i class="conum" data-value="10"></i><b>(10)</b>
        return OrderStatus.CANCELED_ORDER;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>OrderInitializeExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#saga_executors" class="xref page"><code>@SagaExecutor</code></a> annotation.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class has been extended from the <code>CommandExecutor</code>.
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#command_executor" class="xref page"><code>CommandExecutor</code></a> annotation.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Autowire the <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/service/internal/OrderService.java"><code>OrderService</code></a> service to make the execution.
(<code>ObjectMapper</code> has been Autowired just for getting the JSON string)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Overridden the <code>doProcess</code> and <code>doRevert</code> methods.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialize the order-details by calling the orderService.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>After Initializing the order successfully, SEC is navigated to the next executor by using <code>stepManager.next</code>.
The next executor is <code>PreAuthExecutor</code> and also the current executed is marked as <code>INITIALIZED_ORDER</code> in the event-store.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The order is marked as <code>canceled</code> one if the primary execution should be reverted.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Update the hint-store object by adding current millisecond and the revert method name with the executor name while the revert process. <br>
In your real application, <a href="#//">the hint-store</a> can be used for adding some data regarding the revert process.
It can be accessed from the next revert process.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>We used a variable called <code>hasRevertError</code> in the aggregator to <a href="stacksaga-demo.html#revert_failed_transaction" class="xref page">test</a> a <code>revert-failed</code> transaction.
If we have passed the <code>hasRevertError</code> value as <code>true</code>, throw an exception to terminate the transaction.
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is totally testing purpose only.
In your real application make sure to do not throw an exception from the doRevert method unless <code>RetryableExecutorException</code>.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>If the canceling process is successfully executed, return the event name as CANCELED_ORDER.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating_user_detail_executor"><a class="anchor" href="#creating_user_detail_executor"></a>Creating UserDetailExecutor</h3>
<div class="paragraph">
<p>In the <code>OrderController</code> class The <code>UserDetailExecutor</code> has been mentioned as the initial executor.
As per the diagram, you know that executor should be a <code>Query-Executor</code>.
Because the requirement is only fetching the user details.
Fetching user details doesn&#8217;t change any data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
@SagaExecutor(executeFor = "user-service", liveCheck = false, value = "UserDetailExecutor")
@RequiredArgsConstructor
public class UserDetailExecutor implements QueryExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    <i class="conum" data-value="3"></i><b>(3)</b>
    private final UserService userService;

    @Override
    public ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
            PlaceOrderAggregator currentAggregator, <i class="conum" data-value="4"></i><b>(4)</b>
            ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager <i class="conum" data-value="5"></i><b>(5)</b>
    ) throws
    RetryableExecutorException, NonRetryableExecutorException <i class="conum" data-value="6"></i><b>(6)</b>
    {
        currentAggregator.getExecutions().add(this.getClass().getSimpleName()+":"+ LocalDateTime.now());
        <i class="conum" data-value="7"></i><b>(7)</b>
        UserDetailDto.ResponseBody userDetails = this.userService.getUserDetails(currentAggregator.getUserId());
        <i class="conum" data-value="8"></i><b>(8)</b>
        currentAggregator.setDeliveryDetails(userDetails.getDeliveryDetails());
        return stepManager.next(OrderInitializeExecutor.class, OrderStatus.USER_DETAILS_FETCHED); <i class="conum" data-value="9"></i><b>(9)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>UserDetailExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#saga_executors" class="xref page"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>UserDetailExecutor</code> from the <code>QueryExecutor</code> by passing the target Aggregator.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#query_executor" class="xref page"><code>QueryExecutor&lt;A&gt;</code></a> interface.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Autowire the <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/service/external/UserService.java"><code>UserService</code></a>
to make the execution by calling the <code>user-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>you will have the <code>currentAggregator</code> object through the method parameter. due to this executor is the 1st executor, the <code>currentAggregator</code> object contains the initialized values from the <a href="creating-controller.html#orderController_source" class="xref page">OrderController</a> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>stepManager</code> helps you to navigate the execution to the next executor.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If you throw an exception, that is how the framework knows that the executor has an exception at this moment.
Based on the exception type that you have thrown, The framework decides that the process should be started the revert process or either process should be stopped temporally.
<div class="paragraph">
<p>IF the exception is a <code>RetryableExecutorException</code> the framework stops the process temporally.
Or if the exception is a <code>NonRetryableExecutorException</code> the framework knows that the execution cannot be processed to forward anymore and the revert process should be started.
Throwing an exception can be implemented in the method as well.
But in this example, we categorize the exceptions whether the exception is a <code>RetryableExecutorException</code> or otherwise a <code>NonRetryableExecutorException</code> in the <a href="#creating_user_service">UserService</a> (service layer).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../framework/retryable_executor_exception.html" class="xref page">RetryableExecutorException</a> and <a href="../framework/non_retryable_executor_exception.html" class="xref page">NonRetryableExecutorException</a>.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>By using the UserService&#8217;s <code>getUserDetails()</code> method, fetches the user&#8217;s data from user <code>user-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>After receiving the user&#8217;s detail the <code>currentAggregator</code> is updated with user&#8217;s details.
Therefore, you can access the user&#8217;s detail within the next executor.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>By using the <code>stepManager</code>, navigates the execution to the next executor called and the event name marked as <code>USER_DETAILS_FETCHED</code> <a href="creating-OrderInitializeExecutor.html#creating_order_initialize_executor" class="xref page">OrderInitializeExecutor</a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating_user_service"><a class="anchor" href="#creating_user_service"></a>Creating UserService.</h3>
<div class="paragraph">
<p><code>Userservice</code> is a regular spring service that creates for calling <code>user-service</code>.
Due to the <code>user-service</code> is another utility service we have to call it through http or any other protocol that target service supports (Most probably API endpoints are exposed by http protocol).
This example&#8217;s <code>user-service</code> also support http endpoint to access the API.
Therefore, we will be using rest template as http client.
But you can use any Http client like Feign-client, Okhttp, Spring-webclient and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
@RequiredArgsConstructor
public class UserService {

    private final RestTemplate restTemplate;

    public UserDetailDto.ResponseBody getUserDetails(String userId)
            throws
            NonRetryableExecutorException,  RetryableExecutorException <i class="conum" data-value="1"></i><b>(1)</b>
    {

        try {
            <i class="conum" data-value="2"></i><b>(2)</b>
            UserDetailDto.ResponseBody responseBody = this.restTemplate.getForObject(
                    "http://user-service/users/{userId}",
                    UserDetailDto.ResponseBody.class,
                    userId
            );
            assert responseBody != null;
            return responseBody;
        } catch (HttpClientErrorException ex) { <i class="conum" data-value="3"></i><b>(3)</b>
            // This exception is thrown for HTTP 4xx errors (Client errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.NOT_FOUND)) {
                <i class="conum" data-value="4"></i><b>(4)</b>
                throw NonRetryableExecutorException
                        .buildWith(
                                new RuntimeException("User not found"),
                                ""
                        )
                        .put("reason", "User not found")
                        .build();
            } else {
                <i class="conum" data-value="5"></i><b>(5)</b>
                throw NonRetryableExecutorException.buildWith(ex, "").build();
            }
        } catch (HttpServerErrorException ex) { <i class="conum" data-value="6"></i><b>(6)</b>
            // This exception is thrown for HTTP 5xx errors (Server errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <i class="conum" data-value="7"></i><b>(7)</b>
                throw NonRetryableExecutorException.buildWith(ex, "").build();
            } else {
                <i class="conum" data-value="8"></i><b>(8)</b>
                //502 , 503, 504, 509 etc.
                throw RetryableExecutorException.buildWith(ex).build();
            }
        } catch (RestClientException ex) { <i class="conum" data-value="9"></i><b>(9)</b>
            // This exception is a generic RestClientException
            // Handle other types of exceptions here
            throw ex; <i class="conum" data-value="10"></i><b>(10)</b>
        } catch (IllegalArgumentException illegalArgumentException) { <i class="conum" data-value="11"></i><b>(11)</b>
            throw RetryableExecutorException.buildWith(illegalArgumentException).build();
        } catch (RunT) { <i class="conum" data-value="11"></i><b>(11)</b>
            throw RetryableExecutorException.buildWith(illegalArgumentException).build();
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Handling the exceptions is the most important task in StackSaga framework.
You have to handle the exception, and decide what should be the <code>NonRetryableExecutorException</code> and what should be the <code>RetryableExecutorException</code> carefully.
For example, in this demo you saw that we handled <code>NOT_FOUND</code> status.
the <code>NOT_FOUND</code> can be thrown if the <mark>endpoint not found</mark> that you are looking for.
Or otherwise it can be passed if the <mark>user does not exist</mark>.
Then, if you have not any awareness about what the target service returns, you will not be able to catch the real error.
In this example, we know exactly there is an endpoint <code>/users/{userId}</code> in the user-service therefore no worries.
But be careful if you access third party APIs.
Read the API documentation in detail.
</td>
</tr>
</table>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We have thrown both <code>NonRetryableExecutorException</code>,and <code>RetryableExecutorException</code> that UserDetailExecutor&#8217;s <code>doPrcess()</code> method expects.
That&#8217;s why it was mentioned in above.
The handling exception part is done in the service layer.
<div class="paragraph">
<p>[ Read the <a href="creating-UserDetailExecutor.html#exception_tip" class="xref page">TIP</a> ]</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the http request to the user-service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>4xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Due to the http error code is equal to NOT_FOUND (404), the process cannot be done anymore.
Therefore, a <code>NonRetryableExecutorException</code> is thrown by wrapping with the real exception.
If you want to put some data based on the exception, you can use the <code>put("key","value")</code> method for that.
The data can be accessed from any revert-exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Other 4xx errors are thrown as the <code>NonRetryableExecutorException</code> by wrapping the real error.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Check the 5xx error is equal to <code>INTERNAL_SERVER_ERROR</code>.
Because if there is an internal server in this case, we know that we cannot go ahead and the process should be stopped going forward.
Therefore, <code>NonRetryableExecutorException</code> is thrown by wrapping the real letter.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Cathe the other exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>In this example, that other error codes are not considered because we assume that errors cannot be happened.
Therefore, that error just throws without wrapping with <code>NonRetryableExecutorException</code>.
IF you want to wrap, you can do as usual but is not required if you don&#8217;t consider those errors.
Because internally the framework wraps the all <code>RuntimeExceptions</code> with <code>NonRetryableExecutorException</code> by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Due to we are using <code>spring-cloud-load-balancer</code>, when we make a request via the <code>RestTemplate</code> internally load balancer check is there any registered services in the local cache.
Then, if there is no instance in the cache, it throws and exception with <code>IllegalArgumentException</code>.
But in our case, actuality it is also a retryable exception.
Because when an instance is registered, that execution can be invoked.
Therefore, that error is thrown as <code>RetryableExecutorException</code>.</td>
</tr>
</table>
</div>
<div id="exception_tip" class="exampleblock">
<div class="content">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The reason for handling the exception is that this is where the http client does the invocation and the special this is most probably the exceptions are different to each other even though the http status code is the same.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Case-1</dt>
<dd>
<p>IF you change the Rest-Client (For instance, you move to RestTemplate to Feign-client), all the exceptions are changed.
Then you have to change all the codes in the executor if you have handled the exceptions inside the executor.
But in this way nothing to do anything.</p>
</dd>
<dt class="hdlist1">Case-2</dt>
<dd>
<p>If you have to change the protocol like HttpRest to GRPC, you have nothing to do in the executor layer.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_preauthexecutor_command_executor"><a class="anchor" href="#_creating_preauthexecutor_command_executor"></a>Creating PreAuthExecutor (Command-Executor)</h3>
<div class="paragraph">
<p>After initiating the order details, next we will be creating an executor called <code>PreAuthExecutor</code>.
It is responsible for making <code>PreAuth</code> by calling to the utility <code>payment-service</code>.
Due to the execution should be reverted if the entire process is not successful as wished, the <code>PreAuthExecutor</code> is implemented from the <code>CommandExecutor</code> interface.</p>
</div>
<div class="paragraph">
<p>TO make the PreAuth request, we should provide the <code>userId</code>, <code>amount</code> and <code>orderId</code>.
And to revert the process we have to provide the <code>PreAuthRef</code> back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
@SagaExecutor(executeFor = "payment-service", liveCheck = false, value = "PreAuthExecutor")
@RequiredArgsConstructor
public class PreAuthExecutor implements CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    private final PaymentService paymentService;

    @Override
    public ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
            PlaceOrderAggregator currentAggregator, <i class="conum" data-value="3"></i><b>(3)</b>
            ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager
    ) throws RetryableExecutorException, NonRetryableExecutorException {
        currentAggregator.getExecutions().add(this.getClass().getSimpleName()+":"+ LocalDateTime.now());
        <i class="conum" data-value="4"></i><b>(4)</b>
        final String preAuthRef = this.paymentService.makePreAuth(
                PreAuthDto
                        .RequestBody
                        .builder()
                        .userId(currentAggregator.getUserId())
                        .amount(currentAggregator.getAmount())
                        .orderId(currentAggregator.getAggregatorTransactionId())
                        .build()
        );
        <i class="conum" data-value="5"></i><b>(5)</b>
        currentAggregator.setPreAuthRef(preAuthRef);
        <i class="conum" data-value="6"></i><b>(6)</b>
        return stepManager.next(StockUpdateExecutor.class, OrderStatus.MADE_PRE_AUTH);
    }

    @Override
    public SagaExecutionEventName doRevert(
            NonRetryableExecutorException processException,
            PlaceOrderAggregator finalAggregatorState,
            RevertHintStore revertHintStore
    )
    throws RetryableExecutorException { <i class="conum" data-value="7"></i><b>(7)</b>

        this.paymentService.releasePreAuth(
                PreAuthReleaseDto.RequestBody.builder()
                        <i class="conum" data-value="8"></i><b>(8)</b>
                        .pareAuthRef(finalAggregatorState.getPreAuthRef())
                        <i class="conum" data-value="9"></i><b>(9)</b>
                        .reason(processException.get("reason").orElse(""))
                        .build()
        );
        revertHintStore.put(
                String.valueOf(System.currentTimeMillis()),
                this.getClass().getSimpleName() + ":doRevert"
        );<i class="conum" data-value="10"></i><b>(10)</b>

        return return OrderStatus.RELEASED_PRE_AUTH; <i class="conum" data-value="11"></i><b>(11)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>PreAuthExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#saga_executors" class="xref page"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>PreAuthExecutor</code> from the <code>CommandExecutor</code> by passing the target Aggregator.
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#command_executor" class="xref page"><code>CommandExecutor&lt;A&gt;</code></a> interface.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>you will have the <code>currentAggregator</code> object through the method parameter. due to this executor is the 3rd executor, the <code>currentAggregator</code> object has been updated by the <code>OrderController</code>(initialization), <code>UserDetailExecutor</code>,and <code>OrderInitializeExecutor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>make the pre-auth process by invoking the PaymentService&#8217;s <code>makePreAuth()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Update the <code>currentAggregator</code> with <code>preAuthRef</code> data that received as the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Navigates the execution by using <code>stepManager</code> to the next executor called <code>StockUpdateExecutor</code>.
And also passed the status as <code>MADE_PRE_AUTH</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>RetryableExecutorException</code> As per the StackSaga design pattern the revert process cannot have any <code>NonRetryableExecutorException</code> error.
It only can have <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>For Calling the PaymentService&#8217;s <code>releasePreAuth()</code> we have to provide the <code>pareAuthRef</code> data.
So we have the last aggregator data that was updated until the end of the process to forward.
Therefore, that contains the <code>pareAuthRef</code> and we can access it from the <code>finalAggregatorState</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>And As well as a reason should be given for the releasing <code>PreAuth</code>.
All the time the process can be failed (With  <code>NonRetryableExecutorException</code>)we have added a data called <code>reason</code> with the <code>NonRetryableExecutorException</code>.
This is the time that can be used.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Update the hint-store object by adding current millisecond and the revert method name with the executor name while the revert process. <br>
In your real application, <a href="#//">the hint-store</a> can be used for adding some data regarding the revert process.
It can be accessed from the next revert process.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Return the status as <code>RELEASED_PRE_AUTH</code>  finally.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_paymentservice"><a class="anchor" href="#_creating_paymentservice"></a>Creating PaymentService</h3>
<div class="paragraph">
<p><code>PaymentService</code> is a regular spring service that creates for calling utility <code>payment-service</code>.
Due to the <code>payment-service</code> is another utility service we have to call it through http or any other protocol that target service supports (Most probably API endpoints are exposed by http protocol).
This example&#8217;s <code>payment-service</code> also support http endpoint to access the API.
Therefore, we will be using rest template as http client.
But you can use any Http client like Feign-client, Okhttp, Spring-webclient and so on.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The relationship between the executor and service should not be <strong>one-to-one</strong>.
A service can be used for many executors.
In this example, the <code>PaymentService</code> class is used for <code>PreAuthExecutor</code> both executors.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
@RequiredArgsConstructor
public class PaymentService {

    private final RestTemplate restTemplate;

    public String makePreAuth(PreAuthDto.RequestBody requestBody)
        throws RetryableExecutorException, NonRetryableExecutorException { <i class="conum" data-value="1"></i><b>(1)</b>

        try {
            <i class="conum" data-value="2"></i><b>(2)</b>
            PreAuthDto.ResponseBody responseBody = this.restTemplate.postForObject(
                    "http://payment-service/pre-auth",
                    requestBody,
                    PreAuthDto.ResponseBody.class
            );
            assert responseBody != null;
            <i class="conum" data-value="3"></i><b>(3)</b>
            return responseBody.getPreAuthRef();
        } catch (HttpClientErrorException ex) { <i class="conum" data-value="4"></i><b>(4)</b>
            // This exception is thrown for HTTP 4xx errors (Client errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.FORBIDDEN)) {
                <i class="conum" data-value="5"></i><b>(5)</b>
                throw NonRetryableExecutorException
                        .buildWith(
                                new InsufficientBalanceException("Balance not sufficient"),
                                ""
                        )
                        .build();
            } else {
                <i class="conum" data-value="6"></i><b>(6)</b>
                throw NonRetryableExecutorException.buildWith(ex, "").build();
            }
        } catch (HttpServerErrorException ex) {  <i class="conum" data-value="7"></i><b>(7)</b>
            // This exception is thrown for HTTP 5xx errors (Server errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <i class="conum" data-value="8"></i><b>(8)</b>
                throw NonRetryableExecutorException.buildWith(ex, "").build();
            } else {
                //502 , 503, 504, 509 etc.
                <i class="conum" data-value="9"></i><b>(9)</b>
                throw RetryableExecutorException.buildWith(ex).build();
            }
        } catch (RestClientException ex) {  <i class="conum" data-value="10"></i><b>(10)</b>
            // This exception is a generic RestClientException
            // Handle other types of exceptions here
            <i class="conum" data-value="11"></i><b>(11)</b>
            throw ex;
        } catch (IllegalArgumentException illegalArgumentException) {
            throw RetryableExecutorException.buildWith(illegalArgumentException).build();
        }

    }

    public void releasePreAuth(PreAuthReleaseDto.RequestBody requestBody) throws RetryableExecutorException {
        try {
            <i class="conum" data-value="12"></i><b>(12)</b>
            this.restTemplate.put(
                    "http://payment-service/pre-auth/release",
                    requestBody
            );
        } catch (HttpServerErrorException ex) {<i class="conum" data-value="13"></i><b>(13)</b>
            // This exception is thrown for HTTP 5xx errors (Server errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <i class="conum" data-value="14"></i><b>(14)</b>
                throw NonRetryableExecutorException.buildWith(ex, "").build();
            } else {
                //502 , 503, 504, 509 etc.
                <i class="conum" data-value="15"></i><b>(15)</b>
                throw RetryableExecutorException.buildWith(ex).build();
            }
        } catch (RestClientException ex) { <i class="conum" data-value="16"></i><b>(16)</b>
            // This exception is thrown for HTTP 4xx errors (Client errors)
            // You can handle specific HTTP error codes here
            <i class="conum" data-value="17"></i><b>(17)</b>
            throw ex;
        } catch (IllegalArgumentException illegalArgumentException) {
            throw RetryableExecutorException.buildWith(illegalArgumentException).build();
        } catch (RuntimeException restOfExceptions) { <i class="conum" data-value="18"></i><b>(18)</b>
            log.error("Unhanded exception : {}", restOfExceptions.getMessage());
            log.warn("Unhanded exception was occurred and ignored while releasing pre-auth: {}", restOfExceptions.getMessage());
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We have thrown both <code>NonRetryableExecutorException</code>,and <code>RetryableExecutorException</code> that PreAuthExecutor&#8217;s <code>doPrcess()</code> method expects.
The handling exception part is done in the service layer.
<div class="paragraph">
<p>[ Read the <a href="creating-UserDetailExecutor.html#exception_tip" class="xref page">TIP</a> ]</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the http request to the utility payment-service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the <code>authRef</code> that received as the response to the <code>PreAuthExecutor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>4xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>An error can be thrown by the payment-service when we try to make a pre-auth if the user has no enough balance for making the pre-auth.
Therefore, the <code>FORBIDDEN</code> error code is filtered and throws it as <code>NonRetryableExecutorException</code> wrapping with a new exception called <code>InsufficientBalanceException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Other 4xx errors are thrown as <code>NonRetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Check the 5xx error is equal to <code>INTERNAL_SERVER_ERROR</code>.
Because if there is an internal server in this case, we know that we cannot go ahead and the process should be stopped going forward.
Therefore, <code>NonRetryableExecutorException</code> is thrown by wrapping the real letter.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Cathe the other exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>In this example, other error codes are not considered because we assume that errors cannot be happened.
Therefore, that error just throws without wrapping with <code>NonRetryableExecutorException</code>.
IF you want to wrap, you can do as usual but is not required if you don&#8217;t consider those errors.
Because internally the framework wraps the all <code>RuntimeExceptions</code> with <code>NonRetryableExecutorException</code> by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Making the request to the utility payment-service to release the PreAuth that we made.
This method is the Compensating of the <code>makePreAuth</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Cathe the other exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>In this example, other error codes are not considered because we assume that errors cannot be happened.
Therefore, that error just throws without wrapping with <code>NonRetryableExecutorException</code>.
IF you want to wrap, you can do as usual but is not required if you don&#8217;t consider those errors.
Because internally the framework wraps the all <code>RuntimeExceptions</code> with <code>NonRetryableExecutorException</code> by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="18"></i><b>18</b></td>
<td>Ignore other all unknown (Unhandled) exceptions to avoid the transaction termination.</td>
</tr>
</table>
</div>
<div id="tip_for_avoid_transaction_termination" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you think that, even if the revert execution is failed for some reason (due to an unhandled exception,) the rest of revert executions should be run without terminating the transaction, you can flow this.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_stockupdateexecutor_command_executor"><a class="anchor" href="#_creating_stockupdateexecutor_command_executor"></a>Creating StockUpdateExecutor (Command-Executor)</h3>
<div class="paragraph">
<p><code>StockUpdateExecutor</code> is responsible for updating (reduce) the stock by connecting with the utility stock-service.
After reducing the stock to place the order, an error occurred that reduced stock should be restored because the order will be canceled.
That means that the execution has Compensating.
Therefore, the executor should be a <code>Command-Executor</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
@SagaExecutor(executeFor = "stock-service", liveCheck = false, value = "StockUpdateExecutor")
@RequiredArgsConstructor
public class StockUpdateExecutor implements CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    private final StockService stockService;

    @Override
    public ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
            PlaceOrderAggregator currentAggregator, <i class="conum" data-value="3"></i><b>(3)</b>
            ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager
    )
    throws RetryableExecutorException, NonRetryableExecutorException {
        currentAggregator.getExecutions().add(this.getClass().getSimpleName()+":"+ LocalDateTime.now());
        <i class="conum" data-value="4"></i><b>(4)</b>
        this.stockService.updateStock(
                UpdateStockDto.RequestBody
                        .builder()
                        .orderId(currentAggregator.getAggregatorTransactionId())
                        .items(currentAggregator
                                .getItems()
                                .stream()
                                .collect(
                                        Collectors.toMap(
                                                OrderItem::getItemId,
                                                OrderItem::getQty
                                        )
                                )
                        )
                        .build()
        );
        <i class="conum" data-value="5"></i><b>(5)</b>
        return stepManager.next(MakePaymentExecutor.class, OrderStatus.UPDATED_STOCK);
    }

    @Override
    public String doRevert(
            NonRetryableExecutorException processException,
            PlaceOrderAggregator finalAggregatorState,
            RevertHintStore revertHintStore
    ) throws RetryableExecutorException { <i class="conum" data-value="6"></i><b>(6)</b>
        <i class="conum" data-value="7"></i><b>(7)</b>
        this.stockService.restoreStock(
                RestoreStockDto.RequestBody
                        .builder()
                        .reason(processException
                                .get("reason")
                                .orElse("")
                        )
                        .build()
        );
        <i class="conum" data-value="8"></i><b>(8)</b>
        revertHintStore.put(
                String.valueOf(System.currentTimeMillis()),
                this.getClass().getSimpleName() + ":doRevert"
        );
        <i class="conum" data-value="9"></i><b>(9)</b>
        return OrderStatus.RESTORED_STOCK;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Highlights</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>StockUpdateExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#saga_executors" class="xref page"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>StockUpdateExecutor</code> from the <code>CommandExecutor</code> by passing the target Aggregator.
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#command_executor" class="xref page"><code>CommandExecutor&lt;A&gt;</code></a> interface.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>you will have the <code>currentAggregator</code> object through the method parameter. due to this executor is the 4th executor, the <code>currentAggregator</code> object has been updated by the <code>OrderController</code>(initialization), <code>UserDetailExecutor</code>, <code>OrderInitializeExecutor</code>,and <code>PreAuthExecutor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>updating the stock by invoking the StockService&#8217;s <code>updateStock()</code> method. the <code>orderId</code> and <code>items</code> are passed accessing from the <code>currentAggregator</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Navigates the execution by using <code>stepManager</code> to the next executor called <code>MakePaymentExecutor</code>.
And also passed the status as <code>UPDATED_STOCK</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>RetryableExecutorException</code> As per the StackSaga design pattern the revert process cannot have any <code>NonRetryableExecutorException</code> error.
It only can have <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Calling the StockService&#8217;s <code>restoreStock()</code> method to restoring the items that has been reduced in the <code>doProcess()</code> method.
To restore the Stock, we have to pass a reason.
Due to we have put a reason all the possible times when an <code>NonRetryableExecutorException</code> is occurred in <code>doProcess</code> executions.
If the value doesn&#8217;t exist in the exception object we have passed just empty <code>String</code> there.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Update the hint-store object by adding current millisecond and the revert method name with the executor name while the revert process. <br>
In your real application, <a href="#//">the hint-store</a> can be used for adding some data regarding the revert process. It can be accessed from the next revert process.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Returns the status as <code>RESTORED_STOCK</code> finally.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Related classes</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_stockservice"><a class="anchor" href="#_creating_stockservice"></a>Creating StockService</h3>
<div class="paragraph">
<p>We called the <code>StockService</code> in the <code>StockUpdateExecutor</code>.
The service <code>StockService</code> class is responsible for updating the stock or if there is an error, restore the stock by connecting with the utility <code>stock-service</code>.
So let&#8217;s create the service now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
@RequiredArgsConstructor
public class StockService {

    private final RestTemplate restTemplate;

    public void updateStock(UpdateStockDto.RequestBody requestBody)
            throws
            RetryableExecutorException, NonRetryableExecutorException {
        try {
            <i class="conum" data-value="1"></i><b>(1)</b>
            this.restTemplate.put(
                    "http://stock-service/stock",
                    requestBody
            );
        } catch (HttpServerErrorException ex) { <i class="conum" data-value="2"></i><b>(2)</b>
            // This exception is thrown for HTTP 5xx errors (Server errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                throw ex;
            } else {
                //502 , 503, 504, 509 etc.
                throw RetryableExecutorException.buildWith(ex).build();
            }
        } catch (RestClientException ex) { <i class="conum" data-value="3"></i><b>(3)</b>
            // This exception is a generic RestClientException
            // Handle other types of exceptions here
            throw ex;
        }

    }

    public void restoreStock(RestoreStockDto.RequestBody requestBody) throws RetryableExecutorException {
        try {
            <i class="conum" data-value="4"></i><b>(4)</b>
            this.restTemplate.put(
                    "http://stock-service/stock/restore",
                    requestBody
            );
        } catch (HttpServerErrorException ex) { <i class="conum" data-value="5"></i><b>(5)</b>
            // This exception is thrown for HTTP 5xx errors (Server errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                throw ex;
            } else {
                //502 , 503, 504, 509 etc.
                throw RetryableExecutorException.buildWith(ex).build();
            }
        } catch (RestClientException ex) { <i class="conum" data-value="6"></i><b>(6)</b>
            // This exception is a generic RestClientException
            // Handle other types of exceptions here
            throw ex;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This service is also pretty much the same as the service that has been created so far.</p>
</div>
<div class="paragraph">
<p><strong>Highlights</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call the endpoint to update the stock.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cathe the other exceptions (with 4xx errors as well).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call the endpoint to restore the updated stock.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Cathe the other exceptions (with 4xx errors as well).</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_makepaymentexecutor_command_executor"><a class="anchor" href="#_creating_makepaymentexecutor_command_executor"></a>Creating MakePaymentExecutor (Command-Executor)</h3>
<div class="paragraph">
<p><code>MakePaymentExecutor</code> is the final executor as per the diagram. this executor interacts with the utility <code>payment-service</code>.
in the <code>PreAuthExecutor</code> also we accessed the utility <code>payment-service</code> for making the pre-auth.
his executor is responsible for making the real payment for that <code>pre-auth</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
@SagaExecutor(executeFor = "stock-service", liveCheck = false, value = "StockUpdateExecutor")
@RequiredArgsConstructor
public class MakePaymentExecutor implements CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    private final PaymentService paymentService; <i class="conum" data-value="3"></i><b>(3)</b>

    @Override
    public ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
                PlaceOrderAggregator currentAggregator,
                ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager
    ) throws RetryableExecutorException, NonRetryableExecutorException {
        currentAggregator.getExecutions().add(this.getClass().getSimpleName()+":"+ LocalDateTime.now());
        <i class="conum" data-value="4"></i><b>(4)</b>
        String paymentId = this.paymentService.makePayment(
                MakePaymentDto
                        .RequestBody
                        .builder()
                        .amount(currentAggregator.getAmount())
                        .pareAuthRef(currentAggregator.getPreAuthRef())
                        .userId(currentAggregator.getUserId())
                        .build()
        );
        <i class="conum" data-value="5"></i><b>(5)</b>
        currentAggregator.setPaymentId(paymentId);
        <i class="conum" data-value="6"></i><b>(6)</b>
        return stepManager.complete(OrderStatus.MADE_PAYMENT);
    }

    @Override
    public String doRevert(NonRetryableExecutorException processException, PlaceOrderAggregator finalAggregatorState, RevertHintStore revertHintStore) throws RetryableExecutorException {
        throw new UnsupportedOperationException(); <i class="conum" data-value="7"></i><b>(7)</b>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Highlights</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>MakePaymentExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#saga_executors" class="xref page"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>MakePaymentExecutor</code> from the <code>CommandExecutor</code> by passing the target Aggregator.
<div class="paragraph">
<p>Read more about <a href="../framework/saga_executors.html#command_executor" class="xref page"><code>CommandExecutor&lt;A&gt;</code></a> interface.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Autowire the <code>PaymentService</code>.
The old payment service is used this as well.
(The new methods will be updated below.)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calling the PaymentService&#8217;s <code>makePayment()</code> method for making the payment.
To make the payment, we have to pass the following data.
<div class="dlist">
<dl>
<dt class="hdlist1">-<code>amount</code></dt>
<dd>
<p>initialized at <code>OrderController</code></p>
</dd>
<dt class="hdlist1">-<code>pareAuthRef</code></dt>
<dd>
<p>initialized at <code>PreAuthExecutor</code></p>
</dd>
<dt class="hdlist1">-<code>userId</code></dt>
<dd>
<p>initialized at <code>OrderController</code></p>
</dd>
</dl>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Updates the payment in the <code>currentAggregator</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Due to this step is the finale execution, mentions the <strong>compiled</strong> signal to the SEC by using <code>stepManager.complete</code> method with the status as <code>MADE_PAYMENT</code>.
By mentioning <strong>compiled</strong> signal, the SEC stop the execution and mark the transaction has been successfully completed.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>All other command-executors had a Compensating but in this executor have no any execution for Compensating.
The reason is that this is the final execution of this entire process and there is no any next executor can be failed.
You know that all the revert executions are called as the descending order from where the <code>NonRetryableExecutorException</code> is thrown.
Even this execution is failed for some reason, no need to do a Compensating because that execution already failed.
If this execution failed for some reason, all other executed (successfully executed so far), executor&#8217;s Compensatings should be invoked.
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you add another execution after making the Payment, you must implement the <code>doRevert()</code> method.
Because that new execution is failed for some reason, the payment should be refunded.
Because the payment is already done.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Refer the <a href="#//">reference documentation</a> to see how the executions are invoked.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Related Classes</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_updating_the_paymentservice"><a class="anchor" href="#_updating_the_paymentservice"></a>Updating the PaymentService.</h3>
<div class="paragraph">
<p>To make the payment, we have to create a new method in the existing <code>PaymentService</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public String makePayment(MakePaymentDto.RequestBody requestBody) throws RetryableExecutorException, NonRetryableExecutorException {
        try {
            MakePaymentDto.ResponseBody responseBody = this.restTemplate.postForObject(
                    "http://payment-service/pay",
                    requestBody,
                    MakePaymentDto.ResponseBody.class
            );
            assert responseBody != null;
            log.debug(responseBody.getMessage());
            return responseBody.getPaymentRef();
        } catch (HttpClientErrorException ex) {
            // This exception is thrown for HTTP 4xx errors (Client errors)
            // You can handle specific HTTP error codes here
            throw ex;
        } catch (HttpServerErrorException ex) {
            // This exception is thrown for HTTP 5xx errors (Server errors)
            // You can handle specific HTTP error codes here
            if (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                throw ex;
            } else {
                //502 , 503, 504, 509 etc.
                throw RetryableExecutorException.buildWith(ex).build();
            }
        } catch (RestClientException ex) {
            // This exception is a generic RestClientException
            // Handle other types of exceptions here
            throw ex;
        } catch (IllegalArgumentException illegalArgumentException) {
            throw RetryableExecutorException.buildWith(illegalArgumentException).build();
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>That method is also pretty much the same as the service methods we have been implementing so far.
Just call the target utility service and handle the exception.</p>
</div>
<div class="paragraph">
<p><strong>Related Classes' links</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environment_deployment"><a class="anchor" href="#_environment_deployment"></a>Environment Deployment</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a>Testing</h2>
<div class="sectionbody">

</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="footer-main">
    <figure class="footer-brand">
      <a class="logo" href="https://asciidoctor.org"><img src="../../../_/img/stack-saga-icon.svg" alt="Asciidoctor" width="48"></a>
      <figcaption class="footer-brand-name"><a href="https://asciidoctor.org">StackSAGA</a></figcaption>
    </figure>
    <ul class="footer-brand-links">
      <li><a href="https://asciidoctor.org" target="_blank" rel="noopener">Home</a></li>
      <li><a href="../../..">Docs</a></li>
      <li><a href="https://github.com/asciidoctor" target="_blank" rel="noopener">Source</a></li>
      <li><a href="http://discuss.asciidoctor.org" target="_blank" rel="noopener">Discuss</a></li>
    </ul>
  </div>
  <div class="footer-legal">
    <p>Copyright  2024 Dan Allen, Sarah White, and individual Asciidoctor contributors. Except where noted, the content is licensed under a Creative Commons Attribution 4.0 International (CC BY 4.0) license.</p>
    <p>The UI for this site is based on the default Antora UI and is licensed under the MPL-2.0 license. Several icons are imported from <a href="https://primer.style/octicons/" target="_blank" rel="noopener">Octicons</a> and are licensed under the MIT license.</p>
    <p>AsciiDoc is a Trademark of the Eclipse Foundation, Inc.</p>
  </div>
  <div class="footer-thanks">
    <p>Thanks to our <a href="https://asciidoctor.org/supporters/" target="_blank" rel="noopener">backers</a> and <a href="https://asciidoctor.org/contributors/" target="_blank" rel="noopener">contributors</a> for helping to make this project possible. Additional thanks to:</p>
    <p class="badges">
      <a href="https://opendevise.com" title="Development support by OpenDevise" target="_blank" rel="noopener"><img src="https://secure.gravatar.com/avatar/823717a797dbd78ceff7b26aa397f383.png?size=80" alt="OpenDevise Logo" width="30"></a>
      <a href="https://algolia.com/docsearch" title="Search by Algolia DocSearch" target="_blank" rel="noopener"><img src="../../../_/img/algolia-logo.svg" alt="Algolia logo" width="30"></a>
      <a href="https://netlify.com" title="Deploys by Netlify" target="_blank" rel="noopener"><img src="https://www.netlify.com/img/global/badges/netlify-dark.svg" alt="Deploys by Netlify" width="67"></a>
    </p>
    <p>Authored in AsciiDoc.<br>Produced by <a href="https://antora.org" target="_blank" rel="noopener">Antora</a> and <a href="https://asciidoctor.org" target="_blank" rel="noopener">Asciidoctor</a>.</p>
  </div>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
